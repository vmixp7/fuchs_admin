<% layout("layout") %>

    <!-- Page Content -->
    <div class="flex-grow-1">
        <!-- Topbar -->
        <nav class="navbar navbar-light bg-white border-bottom px-4">
            <span class="navbar-text">ğŸ‘‹ æ­¡è¿ï¼Œ<%= username %></span>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid py-4">
            <h4 class="mb-4"><i class="bi bi-question-circle me-2"></i> å¸¸è¦‹å•é¡Œç®¡ç†</h4>

            <!-- æ–°å¢è¡¨å–® -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light-blue">
                    <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i> æ–°å¢å¸¸è¦‹å•é¡Œ</h5>
                </div>
                <div class="card-body">
                    <form id="qaForm">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <label for="que" class="form-label">å•é¡Œ <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="que" name="que" rows="3" required></textarea>
                            </div>
                            <div class="col-md-5">
                                <label for="ans" class="form-label">ç­”æ¡ˆ <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="ans" name="ans" rows="3" required></textarea>
                            </div>
                            <div class="col-md-2">
                                <label for="num" class="form-label">æ’åºç·¨è™Ÿ</label>
                                <input type="number" class="form-control" id="num" name="num" value="0" min="0">
                                <small class="text-muted">æ•¸å­—è¶Šå°è¶Šå‰é¢</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-light-blue">
                                <i class="bi bi-save me-1"></i> æ–°å¢
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                <i class="bi bi-x-circle me-1"></i> æ¸…é™¤
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- åˆ—è¡¨ -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i> å¸¸è¦‹å•é¡Œåˆ—è¡¨</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="qaTable" class="table table-striped table-hover table-bordered">
                            <thead class="table-light-header">
                                <tr>
                                    <th>ç·¨è™Ÿ</th>
                                    <th>æ’åº</th>
                                    <th>å•é¡Œ</th>
                                    <th>ç­”æ¡ˆ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- è³‡æ–™æœƒç”± DataTables è¼‰å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
        <!-- Main Content -->
    </div>
</div>

<!-- ä¿®æ”¹ Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light-orange">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i> ä¿®æ”¹å¸¸è¦‹å•é¡Œ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId" name="id">
                    <div class="mb-3">
                        <label for="editQue" class="form-label">å•é¡Œ <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editQue" name="que" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editAns" class="form-label">ç­”æ¡ˆ <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editAns" name="ans" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editNum" class="form-label">æ’åºç·¨è™Ÿ</label>
                        <input type="number" class="form-control" id="editNum" name="num" min="0">
                        <small class="text-muted">æ•¸å­—è¶Šå°è¶Šå‰é¢</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-light-orange" onclick="updateQa()">
                    <i class="bi bi-save me-1"></i> æ›´æ–°
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let table;

    // åˆå§‹åŒ– DataTable
    $(document).ready(function () {
        table = $('#qaTable').DataTable({
            ajax: {
                url: '/api/qa',
                dataSrc: ''
            },
            columns: [
                { data: 'id' },
                { data: 'num' },
                { data: 'que' },
                { data: 'ans' },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `
                            <button class="btn btn-sm btn-light-orange" onclick="editQa(${row.id})">
                                <i class="bi bi-pencil"></i> ä¿®æ”¹
                            </button>
                            <button class="btn btn-sm btn-light-red" onclick="deleteQa(${row.id})">
                                <i class="bi bi-trash"></i> åˆªé™¤
                            </button>
                        `;
                    }
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/zh-HANT.json'
            },
            order: [[1, 'asc'], [0, 'desc']]  // å…ˆæŒ‰æ’åºç·¨è™Ÿå‡åºï¼Œå†æŒ‰ ID é™åº
        });
    });

    // æ–°å¢å¸¸è¦‹å•é¡Œ
    $('#qaForm').on('submit', function (e) {
        e.preventDefault();

        const que = $('#que').val();
        const ans = $('#ans').val();
        const num = $('#num').val();

        $.ajax({
            url: '/api/qa',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ que, ans, num }),
            success: function (response) {
                alert('æ–°å¢æˆåŠŸï¼');
                $('#qaForm')[0].reset();
                table.ajax.reload();
            },
            error: function (xhr) {
                alert('æ–°å¢å¤±æ•—ï¼š' + (xhr.responseJSON?.message || 'æœªçŸ¥éŒ¯èª¤'));
            }
        });
    });

    // é–‹å•Ÿä¿®æ”¹è¦–çª—
    function editQa(id) {
        $.get(`/api/qa/${id}`, function (data) {
            $('#editId').val(data.id);
            $('#editQue').val(data.que);
            $('#editAns').val(data.ans);
            $('#editNum').val(data.num);
            $('#editModal').modal('show');
        });
    }

    // æ›´æ–°å¸¸è¦‹å•é¡Œ
    function updateQa() {
        const id = $('#editId').val();
        const que = $('#editQue').val();
        const ans = $('#editAns').val();
        const num = $('#editNum').val();

        $.ajax({
            url: `/api/qa/${id}`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({ que, ans, num }),
            success: function (response) {
                alert('æ›´æ–°æˆåŠŸï¼');
                $('#editModal').modal('hide');
                table.ajax.reload();
            },
            error: function (xhr) {
                alert('æ›´æ–°å¤±æ•—ï¼š' + (xhr.responseJSON?.message || 'æœªçŸ¥éŒ¯èª¤'));
            }
        });
    }

    // åˆªé™¤å¸¸è¦‹å•é¡Œ
    function deleteQa(id) {
        if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¸¸è¦‹å•é¡Œå—ï¼Ÿ')) {
            $.ajax({
                url: `/api/qa/${id}`,
                type: 'DELETE',
                success: function (response) {
                    alert('åˆªé™¤æˆåŠŸï¼');
                    table.ajax.reload();
                },
                error: function (xhr) {
                    alert('åˆªé™¤å¤±æ•—ï¼š' + (xhr.responseJSON?.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            });
        }
    }
</script>
